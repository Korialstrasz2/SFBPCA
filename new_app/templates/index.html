{% extends "base.html" %}

{% block content %}
<section class="query-section" aria-labelledby="query-heading">
  <h2 id="query-heading">Build export queries by personalised account sections</h2>
  <p>
    Create one or more account sections, paste their Account IDs, and generate the SOQL queries required for
    Accounts, Contacts, Individuals, AccountContactRelations, ContactPointPhone, and ContactPointEmail.
  </p>
  <form id="query-config-form" class="query-form" novalidate>
    <div id="account-sections" class="query-sections" aria-live="polite"></div>
    <div class="form-actions">
      <button type="button" class="secondary" id="add-account-section">Add section</button>
      <button type="submit" class="primary">Generate queries</button>
    </div>
  </form>
  <div id="query-output" class="query-results" aria-live="polite"></div>
</section>

<section class="steps" aria-label="Workflow navigation">
  <button class="step-button active" data-target="import-panel">1. Import CSV files</button>
  <button class="step-button" data-target="alerts-panel">2. Run alert analysis</button>
  <button class="step-button" data-target="summary-panel">3. Download alert summary</button>
</section>

<section id="import-panel" class="panel active" aria-labelledby="import-heading">
  <h2 id="import-heading">Step 1 &mdash; Import Salesforce extracts</h2>
  <p>
    Upload the CSV exports for each Salesforce object. The importer clears the current in-memory store, rebuilds the
    relationships, and prepares the data loop for alert evaluation.
  </p>
  <form id="import-form" enctype="multipart/form-data">
    <div class="form-grid">
      {% for entity in entities %}
      <label class="file-input">
        <span class="label-text">{{ entity.replace('_', ' ').title() }}</span>
        <input type="file" name="{{ entity }}" accept=".csv" />
      </label>
      {% endfor %}
    </div>
    <div class="form-actions">
      <button type="submit" class="primary">Upload and rebuild</button>
      <button type="reset" class="secondary">Clear selections</button>
    </div>
  </form>
  <div id="import-feedback" role="status" aria-live="polite" class="feedback"></div>
</section>

<section id="alerts-panel" class="panel" aria-labelledby="alerts-heading">
  <h2 id="alerts-heading">Step 2 &mdash; Evaluate alerts</h2>
  <p>
    The alert loop reviews every Account, traverses related Contacts, Individuals, and Contact Points, and delegates to
    specialised alert checkers. Refresh the alerts after each import to see new results.
  </p>
  <div class="alert-controls">
    <button id="run-alerts" class="primary" type="button">Run alert loop</button>
    <span id="alert-count" class="badge" aria-live="polite"></span>
  </div>
  <div class="alert-tab-panel" role="region" aria-live="polite">
    <ul id="alert-list" class="alert-list"></ul>
  </div>
</section>

<section id="summary-panel" class="panel" aria-labelledby="summary-heading">
  <h2 id="summary-heading">Step 3 &mdash; Download alert summary</h2>
  <p>
    When alerts are available, download a CSV summary containing the alert type, account, contact, and supporting
    metadata. The summary regenerates on every alert run.
  </p>
  <div class="alert-summary" id="alert-summary">
    <div class="alert-summary-controls">
      <button id="download-alerts" class="secondary" type="button" disabled>Download CSV</button>
    </div>
    <table id="alert-summary-table" class="alert-summary-table" hidden>
      <thead>
        <tr>
          <th scope="col">Alert type</th>
          <th scope="col">Account</th>
          <th scope="col">Contact</th>
          <th scope="col">Details</th>
          <th scope="col">Triggered</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <p id="alert-summary-empty" class="alert-summary-empty">Run the alert loop to populate the summary.</p>
  </div>
</section>
{% endblock %}
