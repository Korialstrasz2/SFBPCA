{% extends "base.html" %}

{% block content %}
<section class="query-section" aria-labelledby="query-heading">
  <h2 id="query-heading">Costruisci le query di export per gruppi di account personalizzati</h2>
  <p>
    Crea una o più sezioni di account, incolla gli ID Account e genera le query SOQL richieste per
    Account, Contact, Individual, AccountContactRelation, ContactPointPhone e ContactPointEmail.
  </p>
  <form id="query-config-form" class="query-form" novalidate>
    <div id="account-sections" class="query-sections" aria-live="polite"></div>
    <div class="form-actions">
      <button type="button" class="secondary" id="add-account-section">Aggiungi sezione</button>
      <button type="submit" class="primary">Genera query</button>
    </div>
  </form>
  <div id="query-output" class="query-results" aria-live="polite"></div>
</section>

<section class="steps" aria-label="Navigazione del flusso">
  <button class="step-button active" data-target="import-panel">1. Importa i file CSV</button>
  <button class="step-button" data-target="alerts-panel">2. Avvia le allerte</button>
  <button class="step-button" data-target="summary-panel">3. Scarica il riepilogo</button>
</section>

<section id="import-panel" class="panel active" aria-labelledby="import-heading">
  <h2 id="import-heading">Passo 1 &mdash; Importa gli estratti Salesforce</h2>
  <p>
    Carica i CSV per ogni oggetto Salesforce. L'importatore azzera lo stato in memoria, ricostruisce
    le relazioni e prepara i dati per l'analisi delle allerte.
  </p>
  <form id="import-form" enctype="multipart/form-data">
    <div class="bulk-import-actions">
      <input type="file" id="bulk-file-input" accept=".csv" multiple hidden />
      <button type="button" class="secondary" id="select-all-files">Seleziona tutti i file</button>
    </div>
    <div class="form-grid">
      {% for entity in entities %}
      <label class="file-input">
        <span class="label-text">{{ entity_labels.get(entity, entity.replace('_', ' ').title()) }}</span>
        <input type="file" name="{{ entity }}" accept=".csv" />
      </label>
      {% endfor %}
    </div>
    <div class="form-actions">
      <button type="submit" class="primary">Carica e ricostruisci</button>
      <button type="reset" class="secondary">Pulisci selezioni</button>
    </div>
  </form>
  <div id="import-feedback" role="status" aria-live="polite" class="feedback"></div>
  <div
    id="bulk-mapping-modal"
    class="modal"
    role="dialog"
    aria-modal="true"
    aria-labelledby="bulk-modal-title"
    hidden
  >
    <div class="modal-content" role="document">
      <h3 id="bulk-modal-title">Abbinamento dei file CSV</h3>
      <p id="bulk-modal-description">
        I file selezionati sono stati confrontati con le intestazioni previste. Controlla il riepilogo
        per verificare gli abbinamenti.
      </p>
      <ul id="bulk-mapping-list" class="modal-list" aria-describedby="bulk-modal-description"></ul>
      <div class="modal-actions">
        <button type="button" class="primary" id="bulk-modal-close" data-modal-focus>Chiudi</button>
      </div>
    </div>
  </div>
</section>

<section id="alerts-panel" class="panel" aria-labelledby="alerts-heading">
  <h2 id="alerts-heading">Passo 2 &mdash; Valuta le allerte</h2>
  <p>
    Il ciclo delle allerte analizza ogni Account, attraversa i Contact collegati e delega i controlli
    ai moduli specializzati. Riesegui le allerte dopo ogni import per visualizzare i nuovi risultati.
  </p>
  <div class="alert-controls">
    <button id="run-alerts" class="primary" type="button">Esegui il ciclo allerte</button>
    <span id="alert-count" class="badge" aria-live="polite"></span>
  </div>
  <div class="alert-tab-panel" role="region" aria-live="polite">
    <ul id="alert-list" class="alert-list"></ul>
  </div>
</section>

<section id="summary-panel" class="panel" aria-labelledby="summary-heading">
  <h2 id="summary-heading">Passo 3 &mdash; Scarica il riepilogo delle allerte</h2>
  <p>
    Quando sono disponibili allerte puoi scaricare un file Excel con i dettagli e una pagina dedicata
    alle statistiche riepilogative. I contenuti vengono rigenerati ad ogni esecuzione.
  </p>
  <div class="alert-summary" id="alert-summary">
    <div class="alert-summary-tabs" role="tablist" aria-label="Sezioni del riepilogo allerte">
      <button
        id="summary-tab-details"
        type="button"
        class="summary-tab active"
        data-target="summary-details"
        role="tab"
        aria-selected="true"
        aria-controls="summary-details"
      >
        Dettaglio allerte
      </button>
      <button
        id="summary-tab-stats"
        type="button"
        class="summary-tab"
        data-target="summary-stats"
        role="tab"
        aria-selected="false"
        aria-controls="summary-stats"
      >
        Statistiche riepilogo
      </button>
    </div>
    <div
      id="summary-details"
      class="summary-tab-panel active"
      role="tabpanel"
      aria-labelledby="summary-tab-details"
    >
      <div class="alert-summary-controls">
        <div class="summary-filters" role="group" aria-label="Filtri riepilogo allerte">
          <label class="summary-filter">
            <span>Account</span>
            <select id="filter-account">
              <option value="">Tutti</option>
            </select>
          </label>
          <label class="summary-filter">
            <span>Tipo di allerta</span>
            <select id="filter-alert-type">
              <option value="">Tutti</option>
            </select>
          </label>
          <label class="summary-filter">
            <span>Ruolo contatto</span>
            <select id="filter-contact-role">
              <option value="">Tutti</option>
            </select>
          </label>
        </div>
        <button id="download-alerts" class="secondary" type="button" disabled>Scarica Excel</button>
      </div>
      <table id="alert-summary-table" class="alert-summary-table" hidden>
        <thead>
          <tr>
            <th scope="col">Tipo di allerta</th>
            <th scope="col">Account</th>
            <th scope="col">Contatti</th>
            <th scope="col">Ruoli</th>
            <th scope="col">Focus dati</th>
            <th scope="col">Dettagli</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <p id="alert-summary-empty" class="alert-summary-empty">Esegui il ciclo allerte per popolare il riepilogo.</p>
    </div>
    <div
      id="summary-stats"
      class="summary-tab-panel"
      role="tabpanel"
      aria-labelledby="summary-tab-stats"
      hidden
    >
      <div id="summary-stats-content" class="summary-stats" hidden>
        <section class="summary-stats-section">
          <h3>Indicatori principali</h3>
          <dl class="summary-metrics">
            <div>
              <dt>Allerte totali</dt>
              <dd id="stat-total-alerts">0</dd>
            </div>
            <div>
              <dt>Account caricati</dt>
              <dd id="stat-total-accounts">0</dd>
            </div>
            <div>
              <dt>Account con allerte</dt>
              <dd id="stat-accounts-with-alerts">0</dd>
            </div>
            <div>
              <dt>Contatti con allerte</dt>
              <dd id="stat-unique-contacts">0</dd>
            </div>
            <div>
              <dt>Tipi di allerta</dt>
              <dd id="stat-unique-alert-types">0</dd>
            </div>
            <div>
              <dt>Allerte senza contatto</dt>
              <dd id="stat-alerts-without-contact">0</dd>
            </div>
            <div>
              <dt>Media allerte per account</dt>
              <dd id="stat-average-alerts">0</dd>
            </div>
          </dl>
        </section>
        <section class="summary-stats-section">
          <h3>Statistiche per tipo di allerta</h3>
          <table class="summary-stats-table">
            <thead>
              <tr>
                <th scope="col">Tipo di allerta</th>
                <th scope="col">Allerte</th>
                <th scope="col">Account coinvolti</th>
                <th scope="col">Contatti coinvolti</th>
                <th scope="col">Allerte senza contatto</th>
              </tr>
            </thead>
            <tbody id="summary-stats-per-type"></tbody>
          </table>
        </section>
        <section class="summary-stats-section">
          <h3>Account con più allerte</h3>
          <table class="summary-stats-table">
            <thead>
              <tr>
                <th scope="col">Account</th>
                <th scope="col">Allerte</th>
              </tr>
            </thead>
            <tbody id="summary-stats-top-accounts"></tbody>
          </table>
        </section>
      </div>
      <p id="summary-stats-empty" class="alert-summary-empty">Esegui il ciclo allerte per visualizzare le statistiche riepilogative.</p>
    </div>
  </div>
  <div class="log-panel" aria-labelledby="log-panel-title" aria-live="polite">
    <div class="log-panel-header">
      <h3 id="log-panel-title">Registro esecuzione</h3>
      <div class="log-actions">
        <button id="refresh-log" class="secondary" type="button">Aggiorna log</button>
        <button id="download-log" class="secondary" type="button" disabled>Scarica log</button>
      </div>
    </div>
    <pre id="run-log-output" class="run-log" aria-live="polite" aria-label="Log delle operazioni" hidden></pre>
    <p id="run-log-empty" class="run-log-empty">Esegui un'importazione o un ciclo allerte per popolare il registro.</p>
  </div>
</section>
{% endblock %}
