{% extends "base.html" %}

{% block content %}
<section class="query-section" aria-labelledby="query-heading">
  <h2 id="query-heading">Genera query di esportazione per sezioni di account personalizzate</h2>
  <p>
    Crea una o più sezioni di account, inserisci gli ID Account e genera le query SOQL per Accounts, Contacts,
    Individuals, AccountContactRelations, ContactPointPhone e ContactPointEmail.
  </p>
  <form id="query-config-form" class="query-form" novalidate>
    <div id="account-sections" class="query-sections" aria-live="polite"></div>
    <div class="form-actions">
      <button type="button" class="secondary" id="add-account-section">Aggiungi sezione</button>
      <button type="submit" class="primary">Genera query</button>
    </div>
  </form>
  <div id="query-output" class="query-results" aria-live="polite"></div>
</section>

<section class="steps" aria-label="Navigazione del flusso di lavoro">
  <button class="step-button active" data-target="import-panel">1. Importa i file CSV</button>
  <button class="step-button" data-target="alerts-panel">2. Avvia l'analisi degli avvisi</button>
  <button class="step-button" data-target="summary-panel">3. Scarica il riepilogo</button>
</section>

<section id="import-panel" class="panel active" aria-labelledby="import-heading">
  <h2 id="import-heading">Passo 1 — Importa gli estratti Salesforce</h2>
  <p>
    Carica le esportazioni CSV per ogni oggetto Salesforce. L'importatore pulisce l'archivio in memoria,
    ricostruisce le relazioni e prepara il loop di analisi.
  </p>
  <form id="import-form" enctype="multipart/form-data">
    <div class="form-grid">
      {% for entity in entities %}
      <label class="file-input">
        <span class="label-text">{{ entity.replace('_', ' ').title() }}</span>
        <input type="file" name="{{ entity }}" accept=".csv" />
      </label>
      {% endfor %}
    </div>
    <div class="form-actions">
      <button type="submit" class="primary">Carica e ricostruisci</button>
      <button type="reset" class="secondary">Annulla selezioni</button>
    </div>
  </form>
  <div id="import-feedback" role="status" aria-live="polite" class="feedback"></div>
</section>

<section id="alerts-panel" class="panel" aria-labelledby="alerts-heading">
  <h2 id="alerts-heading">Passo 2 — Valuta gli avvisi</h2>
  <p>
    Il loop scorre ogni Account, analizza i contatti collegati e richiama i controlli dedicati. Esegui nuovamente il
    loop dopo ogni import per aggiornare i risultati.
  </p>
  <div class="alert-controls">
    <button id="run-alerts" class="primary" type="button">Esegui il loop avvisi</button>
    <span id="alert-count" class="badge" aria-live="polite"></span>
  </div>
  <div class="alert-tab-panel" role="region" aria-live="polite">
    <ul id="alert-list" class="alert-list"></ul>
  </div>
</section>

<section id="summary-panel" class="panel" aria-labelledby="summary-heading">
  <h2 id="summary-heading">Passo 3 — Scarica il riepilogo</h2>
  <p>
    Quando sono presenti avvisi puoi scaricare un CSV con il dettaglio per tipo di avviso, account e contatto.
    Il riepilogo viene rigenerato ad ogni esecuzione del loop.
  </p>
  <div class="alert-summary" id="alert-summary">
    <div class="alert-summary-controls">
      <button id="download-alerts" class="secondary" type="button" disabled>Scarica CSV</button>
    </div>
    <table id="alert-summary-table" class="alert-summary-table" hidden>
      <thead>
        <tr>
          <th scope="col">Tipo di avviso</th>
          <th scope="col">Account</th>
          <th scope="col">Contatto</th>
          <th scope="col">Dettagli</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <p id="alert-summary-empty" class="alert-summary-empty">Esegui il loop avvisi per popolare il riepilogo.</p>
  </div>
</section>
{% endblock %}
