{% extends "base.html" %}

{% block content %}
<section class="query-section" aria-labelledby="query-helper-heading">
  <h2 id="query-helper-heading">Build export queries for a set of Accounts</h2>
  <p>
    Paste one or more Account IDs and we will generate SOQL snippets that you can run in Salesforce to
    produce CSV extracts for every supported object.
  </p>
  <form id="query-generator-form" class="query-form">
    <label for="account-ids">Account IDs</label>
    <textarea
      id="account-ids"
      name="account_ids"
      rows="4"
      placeholder="001XXXXXXXXXXXX\n001YYYYYYYYYYYY\n001ZZZZZZZZZZZZ"
      aria-describedby="query-helper-hint"
    ></textarea>
    <p id="query-helper-hint" class="form-hint">
      Separate Account IDs by commas, spaces, or new lines. At least one ID is required to build the queries.
    </p>
    <div class="form-actions">
      <button type="submit" class="primary">Generate queries</button>
      <button type="reset" class="secondary" id="clear-queries">Clear</button>
    </div>
  </form>
  <div id="query-results" class="query-results" aria-live="polite"></div>
</section>

<section class="steps" aria-label="Guided steps">
  <button class="step-button active" data-target="import-step">1. Import CSV files</button>
  <button class="step-button" data-target="alerts-step">2. Review alerts</button>
  <button class="step-button" data-target="alert-config-step">3. Configure alerts</button>
</section>

<section id="import-step" class="panel active" aria-labelledby="import-heading">
  <h2 id="import-heading">Step 1 &mdash; Import Salesforce extracts</h2>
  <p>
    Provide the CSV exports for each Salesforce object. Every upload refreshes the in-memory data
    store and rebuilds the relationships between Accounts, Contacts, Individuals, Contact Points, and AccountContactRelations.
  </p>
  <form id="import-form" enctype="multipart/form-data">
    <div class="form-grid">
      {% for entity in entities %}
      <label class="file-input">
        <span class="label-text">{{ entity.replace('_', ' ').title() }}</span>
        <input type="file" name="{{ entity }}" accept=".csv" />
      </label>
      {% endfor %}
    </div>
    <div class="form-actions">
      <button type="submit" class="primary">Upload and rebuild</button>
      <button type="reset" class="secondary">Clear selections</button>
    </div>
  </form>
  <div id="import-feedback" role="status" aria-live="polite" class="feedback"></div>
</section>

<section id="alerts-step" class="panel" aria-labelledby="alerts-heading">
  <h2 id="alerts-heading">Step 2 &mdash; Investigate generated alerts</h2>
  <p>
    After the import completes, use this dashboard to understand potential data quality issues.
    The default alerts focus on duplicate roles, missing roles, conflicting roles, and duplicate contact points.
  </p>
  <div class="alert-controls">
    <button id="refresh-alerts" class="primary">Refresh alerts</button>
    <span id="alert-count" class="badge" aria-live="polite"></span>
  </div>
  <ul id="alert-list" class="alert-list" aria-live="polite"></ul>
</section>

<section id="alert-config-step" class="panel" aria-labelledby="alert-config-heading">
  <h2 id="alert-config-heading">Step 3 &mdash; Configure alert definitions</h2>
  <p>
    Review, customize, or create alert definitions. Each definition includes the logic that powers the alert,
    making it easy to adjust thresholds or build entirely new checks tailored to your team.
  </p>
  <div class="alert-config">
    <div class="alert-config__list" aria-live="polite">
      <div class="alert-config__header">
        <h3>Available alerts</h3>
        <button id="new-alert-definition" class="secondary">New alert</button>
      </div>
      <ul id="alert-definition-list" class="definition-list"></ul>
    </div>
    <div class="alert-config__editor">
      <form id="alert-definition-form" class="definition-form" novalidate>
        <div class="definition-form__heading">
          <h3 id="alert-definition-form-title">Create alert definition</h3>
          <label class="toggle">
            <input type="checkbox" id="alert-enabled" name="enabled" checked />
            <span>Enabled</span>
          </label>
        </div>
        <div class="form-field">
          <label for="alert-id">Identifier</label>
          <input id="alert-id" name="id" type="text" required autocomplete="off" />
          <p class="field-hint">Unique name used to reference the alert definition.</p>
        </div>
        <div class="form-field">
          <label for="alert-name">Display name</label>
          <input id="alert-name" name="name" type="text" required />
        </div>
        <div class="form-field">
          <label for="alert-description">Description</label>
          <textarea id="alert-description" name="description" rows="2"></textarea>
        </div>
        <div class="form-field">
          <label for="alert-logic-type">Logic type</label>
          <select id="alert-logic-type" name="logic_type"></select>
          <p id="alert-logic-help" class="field-hint"></p>
        </div>
        <div id="alert-parameter-fields" class="parameter-fields" aria-live="polite"></div>
        <div class="form-field form-field--inline">
          <label class="toggle" for="alert-logic-raw">
            <input type="checkbox" id="alert-logic-raw" name="raw_logic" />
            <span>Edit logic JSON directly</span>
          </label>
          <p class="field-hint">
            Enable this mode to customise alert logic beyond the available parameters. Updates are saved back to the
            JSON that powers the alert engine.
          </p>
        </div>
        <p id="alert-logic-raw-notice" class="field-hint" hidden>
          Parameter controls are disabled while editing the raw JSON definition.
        </p>
        <div class="form-field">
          <label for="alert-logic-preview">Logic preview</label>
          <textarea id="alert-logic-preview" class="code" rows="6" readonly aria-describedby="alert-logic-raw-notice"></textarea>
        </div>
        <div class="form-actions">
          <button type="submit" class="primary">Save alert</button>
          <button type="button" id="delete-alert-definition" class="danger" hidden>Delete</button>
        </div>
        <p id="alert-definition-feedback" class="feedback" role="status" aria-live="polite"></p>
      </form>
    </div>
  </div>
</section>
{% endblock %}
